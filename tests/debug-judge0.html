<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Judge0 API è°ƒè¯•å·¥å…·</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        h2 {
            color: #333;
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 10px;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            background: #f9f9f9;
            border-left: 4px solid #2196F3;
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #45a049;
        }
        .output {
            background: #263238;
            color: #aed581;
            padding: 15px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
            margin-top: 10px;
        }
        .error {
            color: #ff5252;
        }
        .success {
            color: #69f0ae;
        }
        .info {
            color: #40c4ff;
        }
        input, textarea {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
        }
        textarea {
            min-height: 150px;
        }
        label {
            font-weight: bold;
            display: block;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <h1>ğŸ”§ Judge0 API è°ƒè¯•å·¥å…·</h1>

    <div class="container">
        <h2>1. æµ‹è¯•è¿æ¥</h2>
        <button onclick="testConnection()">æµ‹è¯• Judge0 è¿æ¥</button>
        <div id="connectionOutput" class="output"></div>
    </div>

    <div class="container">
        <h2>2. ç›´æ¥æµ‹è¯• Judge0 API</h2>
        <p>ç»•è¿‡åç«¯ï¼Œç›´æ¥è°ƒç”¨ Judge0 API</p>
        <button onclick="testDirectJudge0()">ç›´æ¥è°ƒç”¨ Judge0</button>
        <div id="directOutput" class="output"></div>
    </div>

    <div class="container">
        <h2>3. æµ‹è¯•åç«¯ API</h2>
        
        <label>æºä»£ç :</label>
        <textarea id="testCode">print('Hello, Judge0!')
print('æµ‹è¯•æˆåŠŸï¼')</textarea>
        
        <label>è¯­è¨€ID:</label>
        <input type="number" id="testLanguageId" value="71" placeholder="71 = Python">
        
        <label>æ ‡å‡†è¾“å…¥ (å¯é€‰):</label>
        <textarea id="testStdin" style="min-height: 80px;"></textarea>
        
        <button onclick="testBackendRun()">æµ‹è¯•è¿è¡Œä»£ç </button>
        <div id="backendOutput" class="output"></div>
    </div>

    <div class="container">
        <h2>4. æŸ¥çœ‹è¯·æ±‚è¯¦æƒ…</h2>
        <button onclick="showRequestDetails()">æ˜¾ç¤ºè¯·æ±‚ä½“</button>
        <div id="requestDetails" class="output"></div>
    </div>

    <script>
        const BACKEND_URL = 'http://localhost:8080/api/code';
        const JUDGE0_URL = 'http://localhost:2358';

        function log(elementId, message, type = 'info') {
            const output = document.getElementById(elementId);
            const timestamp = new Date().toLocaleTimeString();
            const className = type;
            output.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
            output.scrollTop = output.scrollHeight;
        }

        function clear(elementId) {
            document.getElementById(elementId).innerHTML = '';
        }

        // 1. æµ‹è¯•è¿æ¥
        async function testConnection() {
            clear('connectionOutput');
            log('connectionOutput', 'æ­£åœ¨æµ‹è¯•åç«¯è¿æ¥...', 'info');
            
            try {
                const response = await fetch(`${BACKEND_URL}/test-connection`);
                const data = await response.json();
                
                log('connectionOutput', `å“åº”çŠ¶æ€: ${response.status}`, 'info');
                log('connectionOutput', `å“åº”æ•°æ®: ${JSON.stringify(data, null, 2)}`, 'success');
                
                if (data.success) {
                    log('connectionOutput', 'âœ… è¿æ¥æˆåŠŸï¼', 'success');
                } else {
                    log('connectionOutput', 'âŒ è¿æ¥å¤±è´¥: ' + data.message, 'error');
                }
            } catch (error) {
                log('connectionOutput', 'âŒ è¯·æ±‚é”™è¯¯: ' + error.message, 'error');
            }
        }

        // 2. ç›´æ¥æµ‹è¯• Judge0
        async function testDirectJudge0() {
            clear('directOutput');
            log('directOutput', 'æ­£åœ¨ç›´æ¥è°ƒç”¨ Judge0 API...', 'info');
            
            const sourceCode = "print('Hello from Judge0!')";
            const languageId = 71;
            
            // Base64 ç¼–ç 
            const encodedCode = btoa(unescape(encodeURIComponent(sourceCode)));
            
            const requestBody = {
                source_code: encodedCode,
                language_id: languageId,
                base64_encoded: true
            };
            
            log('directOutput', 'è¯·æ±‚ä½“: ' + JSON.stringify(requestBody, null, 2), 'info');
            
            try {
                const response = await fetch(`${JUDGE0_URL}/submissions?base64_encoded=true&wait=false`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });
                
                log('directOutput', `å“åº”çŠ¶æ€: ${response.status}`, 'info');
                
                const data = await response.json();
                log('directOutput', `å“åº”æ•°æ®: ${JSON.stringify(data, null, 2)}`, 'success');
                
                if (data.token) {
                    log('directOutput', 'âœ… æäº¤æˆåŠŸï¼Token: ' + data.token, 'success');
                    
                    // è·å–ç»“æœ
                    setTimeout(async () => {
                        const resultResponse = await fetch(`${JUDGE0_URL}/submissions/${data.token}?base64_encoded=true`);
                        const result = await resultResponse.json();
                        log('directOutput', 'ç»“æœ: ' + JSON.stringify(result, null, 2), 'success');
                    }, 2000);
                }
            } catch (error) {
                log('directOutput', 'âŒ è¯·æ±‚é”™è¯¯: ' + error.message, 'error');
                log('directOutput', 'æç¤º: è¯·ç¡®ä¿ Judge0 åœ¨ http://localhost:2358 è¿è¡Œ', 'info');
            }
        }

        // 3. æµ‹è¯•åç«¯ API
        async function testBackendRun() {
            clear('backendOutput');
            
            const sourceCode = document.getElementById('testCode').value;
            const languageId = parseInt(document.getElementById('testLanguageId').value);
            const stdin = document.getElementById('testStdin').value;
            
            if (!sourceCode.trim()) {
                log('backendOutput', 'âŒ è¯·è¾“å…¥æºä»£ç ', 'error');
                return;
            }
            
            if (!languageId || languageId <= 0) {
                log('backendOutput', 'âŒ è¯·è¾“å…¥æœ‰æ•ˆçš„è¯­è¨€ID', 'error');
                return;
            }
            
            const requestBody = {
                sourceCode: sourceCode,
                languageId: languageId,
                stdin: stdin
            };
            
            log('backendOutput', 'å‘é€è¯·æ±‚...', 'info');
            log('backendOutput', 'è¯·æ±‚ä½“: ' + JSON.stringify(requestBody, null, 2), 'info');
            
            try {
                const response = await fetch(`${BACKEND_URL}/run`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });
                
                log('backendOutput', `å“åº”çŠ¶æ€: ${response.status}`, 'info');
                
                const data = await response.json();
                log('backendOutput', 'å“åº”æ•°æ®: ' + JSON.stringify(data, null, 2), data.success ? 'success' : 'error');
                
                if (data.success) {
                    log('backendOutput', 'âœ… è¿è¡ŒæˆåŠŸï¼', 'success');
                    const result = data.data;
                    log('backendOutput', `çŠ¶æ€: ${result.status}`, 'info');
                    if (result.stdout) {
                        log('backendOutput', `è¾“å‡º: ${result.stdout}`, 'success');
                    }
                    if (result.stderr) {
                        log('backendOutput', `é”™è¯¯: ${result.stderr}`, 'error');
                    }
                } else {
                    log('backendOutput', 'âŒ è¿è¡Œå¤±è´¥: ' + data.message, 'error');
                }
            } catch (error) {
                log('backendOutput', 'âŒ è¯·æ±‚é”™è¯¯: ' + error.message, 'error');
            }
        }

        // 4. æ˜¾ç¤ºè¯·æ±‚è¯¦æƒ…
        function showRequestDetails() {
            clear('requestDetails');
            
            const sourceCode = document.getElementById('testCode').value;
            const languageId = parseInt(document.getElementById('testLanguageId').value);
            const stdin = document.getElementById('testStdin').value;
            
            const requestBody = {
                sourceCode: sourceCode,
                languageId: languageId,
                stdin: stdin
            };
            
            log('requestDetails', '=== è¯·æ±‚è¯¦æƒ… ===', 'info');
            log('requestDetails', `URL: ${BACKEND_URL}/run`, 'info');
            log('requestDetails', `Method: POST`, 'info');
            log('requestDetails', `Content-Type: application/json`, 'info');
            log('requestDetails', '', 'info');
            log('requestDetails', 'è¯·æ±‚ä½“:', 'info');
            log('requestDetails', JSON.stringify(requestBody, null, 2), 'success');
            log('requestDetails', '', 'info');
            log('requestDetails', 'å‚æ•°ç±»å‹:', 'info');
            log('requestDetails', `sourceCode: ${typeof sourceCode} (é•¿åº¦: ${sourceCode.length})`, 'info');
            log('requestDetails', `languageId: ${typeof languageId} (å€¼: ${languageId})`, 'info');
            log('requestDetails', `stdin: ${typeof stdin} (é•¿åº¦: ${stdin.length})`, 'info');
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æµ‹è¯•è¿æ¥
        window.onload = function() {
            testConnection();
        };
    </script>
</body>
</html>
