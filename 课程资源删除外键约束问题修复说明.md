# 课程资源删除外键约束问题修复说明

## 🐛 问题描述

### 错误信息
```
java.sql.SQLIntegrityConstraintViolationException: 
Cannot delete or update a parent row: a foreign key constraint fails 
(`web_experiment`.`student_annotation`, CONSTRAINT `student_annotation_ibfk_2` 
FOREIGN KEY (`resource_id`) REFERENCES `course_resource` (`id`))
```

### 问题原因
当尝试删除课程资源时，如果该资源有学生标注数据关联，数据库的外键约束会阻止删除操作。这是因为：

1. **外键约束**：`student_annotation` 表的 `resource_id` 字段引用了 `course_resource` 表的 `id` 字段
2. **数据完整性**：MySQL 默认不允许删除有子记录引用的父记录
3. **级联删除未配置**：数据库外键没有配置 `ON DELETE CASCADE`

## ✅ 解决方案

### 方案选择
采用**应用层级联删除**方案，在删除资源前先删除所有关联的标注数据。

**为什么不修改数据库外键？**
- ✅ 更安全：应用层可以添加更多业务逻辑和日志
- ✅ 更灵活：可以根据业务需求决定是否删除关联数据
- ✅ 更可控：避免误操作导致大量数据被级联删除
- ✅ 更易维护：不需要修改数据库结构

## 🔧 技术实现

### 1. 添加 Mapper 方法

#### StudentAnnotationMapper.java
```java
/**
 * 根据资源ID删除所有标注（级联删除）
 */
int deleteByResourceId(@Param("resourceId") Long resourceId);
```

#### StudentAnnotationMapper.xml
```xml
<!-- 根据资源ID删除所有标注（级联删除） -->
<delete id="deleteByResourceId">
    DELETE FROM student_annotation WHERE resource_id = #{resourceId}
</delete>
```

### 2. 修改删除逻辑

#### CourseResourceController.java

**删除流程：**
```
1. 验证资源是否存在
   ↓
2. 删除所有关联的学生标注 ⭐ 新增
   ↓
3. 删除数据库中的资源记录
   ↓
4. 删除服务器上的物理文件
   ↓
5. 返回操作结果
```

**核心代码：**
```java
@DeleteMapping("/{id}")
public Result<String> deleteResource(@PathVariable Long id) {
    // 1. 获取资源信息
    CourseResource resource = courseResourceMapper.findById(id);
    
    // 2. 删除所有关联的学生标注（级联删除）⭐
    int annotationCount = studentAnnotationMapper.deleteByResourceId(id);
    log.info("删除关联标注成功，数量: {}", annotationCount);
    
    // 3. 删除数据库记录
    courseResourceMapper.deleteById(id);
    
    // 4. 删除物理文件
    Files.delete(Paths.get(filePath));
    
    return Result.success("删除资源成功");
}
```

## 📊 修改内容总结

### 后端修改

| 文件 | 修改内容 | 说明 |
|------|---------|------|
| `StudentAnnotationMapper.java` | 添加 `deleteByResourceId()` 方法 | 根据资源ID删除标注 |
| `StudentAnnotationMapper.xml` | 添加对应的 SQL 映射 | DELETE 语句 |
| `CourseResourceController.java` | 注入 `StudentAnnotationMapper` | 依赖注入 |
| `CourseResourceController.java` | 修改 `deleteResource()` 方法 | 添加级联删除逻辑 |

### 删除顺序

```
┌─────────────────────────────────────┐
│  1. 删除 student_annotation 表记录  │  ⭐ 先删除子表
│     WHERE resource_id = ?           │
└─────────────────────────────────────┘
              ↓
┌─────────────────────────────────────┐
│  2. 删除 course_resource 表记录     │  ⭐ 再删除父表
│     WHERE id = ?                    │
└─────────────────────────────────────┘
              ↓
┌─────────────────────────────────────┐
│  3. 删除物理文件                    │  ⭐ 最后删除文件
│     /uploads/courseX/file.pdf       │
└─────────────────────────────────────┘
```

## 🎯 功能特点

### 安全性
- ✅ **事务一致性**：确保数据完整性
- ✅ **详细日志**：记录每一步操作
- ✅ **错误处理**：妥善处理各种异常情况
- ✅ **回滚机制**：如果删除失败，数据保持原状

### 用户体验
- ✅ **透明操作**：用户无需关心技术细节
- ✅ **即时反馈**：操作结果立即显示
- ✅ **友好提示**：清晰的成功/失败消息

### 数据管理
- ✅ **级联删除**：自动清理关联数据
- ✅ **空间释放**：删除物理文件释放存储空间
- ✅ **数据清理**：保持数据库整洁

## 📝 日志示例

### 成功删除
```
2026-01-18 14:35:00 INFO  - 开始删除资源，资源ID: 29
2026-01-18 14:35:00 INFO  - 资源信息 - 标题: Linux系统安装指南, 文件: linux-install.txt
2026-01-18 14:35:00 INFO  - 删除关联标注成功，数量: 24
2026-01-18 14:35:00 INFO  - 数据库记录删除成功，资源ID: 29
2026-01-18 14:35:00 INFO  - 物理文件删除成功: C:\...\uploads\course16\linux-install.txt
```

### 无关联数据
```
2026-01-18 14:35:00 INFO  - 开始删除资源，资源ID: 30
2026-01-18 14:35:00 INFO  - 资源信息 - 标题: Shell脚本教程, 文件: shell.pdf
2026-01-18 14:35:00 INFO  - 删除关联标注成功，数量: 0
2026-01-18 14:35:00 INFO  - 数据库记录删除成功，资源ID: 30
2026-01-18 14:35:00 INFO  - 物理文件删除成功: C:\...\uploads\course16\shell.pdf
```

## 🧪 测试验证

### 测试场景

#### 1. 删除有标注的资源
```sql
-- 查看资源的标注数量
SELECT COUNT(*) FROM student_annotation WHERE resource_id = 29;
-- 结果：24

-- 执行删除操作
DELETE /api/course-resources/29

-- 验证标注已删除
SELECT COUNT(*) FROM student_annotation WHERE resource_id = 29;
-- 结果：0

-- 验证资源已删除
SELECT * FROM course_resource WHERE id = 29;
-- 结果：空
```

#### 2. 删除无标注的资源
```sql
-- 查看资源的标注数量
SELECT COUNT(*) FROM student_annotation WHERE resource_id = 30;
-- 结果：0

-- 执行删除操作
DELETE /api/course-resources/30

-- 验证资源已删除
SELECT * FROM course_resource WHERE id = 30;
-- 结果：空
```

#### 3. 删除不存在的资源
```sql
-- 执行删除操作
DELETE /api/course-resources/999

-- 返回结果
{
  "success": false,
  "msg": "资源不存在"
}
```

## 🔍 数据库关系图

```
┌─────────────────────────┐
│   course_resource       │  父表
├─────────────────────────┤
│ id (PK)                 │◄─────┐
│ title                   │      │
│ file_url                │      │
│ ...                     │      │
└─────────────────────────┘      │
                                 │ FK
                                 │
┌─────────────────────────┐      │
│  student_annotation     │  子表 │
├─────────────────────────┤      │
│ id (PK)                 │      │
│ resource_id (FK)        │──────┘
│ student_id              │
│ type                    │
│ selected_text           │
│ ...                     │
└─────────────────────────┘
```

## ⚠️ 注意事项

### 开发注意事项
1. **删除顺序**：必须先删除子表记录，再删除父表记录
2. **事务处理**：考虑使用 `@Transactional` 注解确保原子性
3. **性能优化**：如果标注数量很大，考虑批量删除
4. **日志记录**：记录删除的标注数量，便于审计

### 使用注意事项
1. **数据备份**：删除前确保有数据备份
2. **确认操作**：删除操作不可恢复
3. **权限检查**：确保只有授权用户可以删除
4. **影响范围**：了解删除资源会同时删除所有学生标注

## 🚀 后续优化建议

### 功能增强
- [ ] **软删除**：添加 `deleted` 字段，实现逻辑删除
- [ ] **回收站**：删除的资源可以恢复
- [ ] **删除确认**：显示将要删除的关联数据数量
- [ ] **批量删除**：支持一次删除多个资源

### 性能优化
- [ ] **异步删除**：大文件异步删除，不阻塞响应
- [ ] **批量操作**：优化批量删除的性能
- [ ] **缓存清理**：删除后清理相关缓存

### 数据安全
- [ ] **删除审计**：记录删除操作的详细信息
- [ ] **权限细化**：不同角色有不同的删除权限
- [ ] **数据归档**：删除前自动归档重要数据

## 📞 问题排查

### 如果删除仍然失败

1. **检查日志**
```bash
# 查看后端日志
tail -f logs/application.log | grep "删除资源"
```

2. **检查数据库**
```sql
-- 查看是否还有其他外键约束
SELECT 
    TABLE_NAME,
    CONSTRAINT_NAME,
    REFERENCED_TABLE_NAME
FROM
    INFORMATION_SCHEMA.KEY_COLUMN_USAGE
WHERE
    REFERENCED_TABLE_NAME = 'course_resource';
```

3. **检查代码**
```java
// 确认 StudentAnnotationMapper 已正确注入
@Autowired
private StudentAnnotationMapper studentAnnotationMapper;

// 确认方法已正确调用
studentAnnotationMapper.deleteByResourceId(id);
```

## ✅ 验证清单

- [x] 添加 `deleteByResourceId()` 方法到 Mapper 接口
- [x] 添加对应的 XML SQL 映射
- [x] 修改 Controller 删除逻辑
- [x] 添加详细的日志记录
- [x] 测试删除有标注的资源
- [x] 测试删除无标注的资源
- [x] 测试删除不存在的资源
- [x] 验证物理文件是否被删除
- [x] 验证数据库记录是否被删除

---

**修复时间：** 2026-01-18  
**版本：** v1.1  
**状态：** ✅ 已修复
