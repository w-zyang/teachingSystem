# PDF标注显示问题排查指南

## 问题描述
后端成功记录了标注（日志显示：`学生17成功创建标注，类型: highlight`），但前端PDF上没有正常显示标注。

## 已添加的调试功能

我已经在 `DocumentViewer.vue` 中添加了详细的调试日志，现在你可以通过以下步骤排查问题：

### 1. 打开浏览器开发者工具
- 按 `F12` 打开开发者工具
- 切换到 **Console（控制台）** 标签

### 2. 重新加载页面并创建标注
刷新页面后，你会看到以下调试信息：

#### 初始化阶段
```
🚀 DocumentViewer组件已挂载
📋 Props: { resourceId: xxx, resourceTitle: xxx, courseId: xxx }
📖 开始加载文档内容，资源ID: xxx
📦 文档API响应: {...}
✅ 文档内容加载成功，长度: xxx
🔍 开始加载标注，学生ID: xxx, 资源ID: xxx
📦 获取标注API完整响应: {...}
✅ 成功加载标注数据: [...]
📊 标注数量: x
```

#### 创建新标注时
```
💾 准备保存新标注: {...}
📦 创建标注API响应: {...}
✅ 标注创建成功，返回数据: {...}
📊 当前标注总数: x
🎨 开始重新渲染文档以显示新标注
```

#### 渲染标注时
```
📝 formatDocumentContent 被调用
📄 文档文本长度: xxx
📌 当前标注数量: x
🎨 开始应用 x 个标注到HTML
📍 标注 #1 位置信息: {...}
✅ 成功应用标注（单节点）
```

### 3. 关键检查点

#### 检查点 1: 标注数据是否正确加载？
查找日志：`✅ 成功加载标注数据`

**如果看到标注数量为 0：**
- 问题在于后端API返回数据
- 检查 `getResourceAnnotations` API 是否正确返回数据
- 检查学生ID和资源ID是否匹配

**如果看到标注数量 > 0：**
- 继续下一步检查

#### 检查点 2: 标注数据格式是否正确？
查看每个标注的详细信息：
```javascript
📌 标注 #1: {
  id: xxx,
  type: "highlight",
  color: "#FFFF00",
  selectedText: "...",
  position: "{...}",
  pageNumber: 1
}
```

**必须检查：**
- `selectedText` 不能为空
- `position` 必须是有效的JSON字符串
- `color` 应该是有效的颜色值

#### 检查点 3: 标注是否被应用到HTML？
查找日志：`🎨 开始应用 x 个标注到HTML`

**如果没有看到这条日志：**
- 问题在于 `formatDocumentContent` 没有被调用
- 或者 `annotations.value.length` 为 0

**如果看到日志但标注未显示：**
- 查看具体的标注应用日志
- 检查是否有 `❌ 未找到对应的文本节点` 错误

#### 检查点 4: 文本匹配是否成功？
查找日志：
- `✅ 文本搜索成功应用标注` - 成功
- `❌ 文本搜索未找到` - 失败
- `✅ 成功应用标注（单节点）` - 成功
- `❌ 未找到对应的文本节点` - 失败

## 常见问题及解决方案

### 问题 1: 标注数据加载失败
**症状：** 控制台显示 `⚠️ 获取标注失败`

**解决方案：**
1. 检查后端API是否正常运行
2. 检查网络请求是否成功（Network标签）
3. 检查后端返回的数据格式是否正确

### 问题 2: 标注文本无法匹配
**症状：** 控制台显示 `❌ 文本搜索未找到`

**原因：**
- 文档内容已更改，标注的文本不再存在
- 标注保存的文本与实际文档文本不一致

**解决方案：**
1. 删除旧标注，重新创建
2. 检查文档内容是否被修改

### 问题 3: 标注创建后立即消失
**症状：** 标注创建成功，但刷新后消失

**原因：**
- 标注没有正确保存到数据库
- 标注的 `resourceId` 或 `studentId` 不正确

**解决方案：**
1. 检查后端日志，确认标注是否保存到数据库
2. 检查数据库中的标注记录
3. 确认 `studentId` 和 `resourceId` 是否正确

### 问题 4: 标注显示位置不正确
**症状：** 标注显示了，但位置不对

**原因：**
- 位置信息保存不正确
- 文档内容与标注创建时不一致

**解决方案：**
1. 使用文本搜索模式（当前已实现）
2. 重新创建标注

## 手动测试步骤

### 步骤 1: 清空现有标注
```javascript
// 在浏览器控制台执行
localStorage.clear()
location.reload()
```

### 步骤 2: 创建新标注
1. 打开文档查看器
2. 选择一段文字
3. 点击"高亮"按钮
4. 观察控制台日志

### 步骤 3: 检查标注是否显示
- 标注应该立即显示在文档中
- 右侧笔记面板应该显示标注列表

### 步骤 4: 刷新页面
- 刷新页面后，标注应该仍然显示
- 检查控制台日志，确认标注被正确加载

## 数据库检查

如果前端一切正常，但标注仍然不显示，检查数据库：

```sql
-- 查看所有标注
SELECT * FROM student_annotation;

-- 查看特定学生的标注
SELECT * FROM student_annotation WHERE student_id = 17;

-- 查看特定资源的标注
SELECT * FROM student_annotation WHERE resource_id = YOUR_RESOURCE_ID;

-- 检查标注数据完整性
SELECT 
  id,
  student_id,
  resource_id,
  type,
  LENGTH(selected_text) as text_length,
  LENGTH(position) as position_length,
  color,
  create_time
FROM student_annotation
WHERE student_id = 17
ORDER BY create_time DESC;
```

## 下一步操作

1. **打开浏览器控制台**，查看详细的调试日志
2. **创建一个新标注**，观察整个过程的日志输出
3. **根据日志信息**，确定问题出在哪个环节
4. **参考上面的解决方案**，修复问题

## 需要提供的信息

如果问题仍然存在，请提供以下信息：

1. **浏览器控制台的完整日志**（从页面加载到创建标注）
2. **Network标签中的API请求和响应**
   - `GET /api/student-annotations/student/{studentId}/resource/{resourceId}`
   - `POST /api/student-annotations`
3. **数据库中的标注记录**
4. **后端日志**（特别是标注创建和查询的日志）

## 临时解决方案

如果标注功能暂时无法正常工作，可以使用以下临时方案：

1. **只使用批注功能**：批注会显示在右侧面板，不依赖文档内渲染
2. **使用笔记功能**：在 `StudyNotes.vue` 中记录学习笔记
3. **导出标注数据**：定期导出标注数据，避免数据丢失

---

**更新时间：** 2026-01-18
**版本：** v1.0
