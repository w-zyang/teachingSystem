# æ•™å­¦æ•ˆç‡æ•°æ®æ›´æ–°ç®—æ³•è¯´æ˜

## ğŸ“Š æ•°æ®æ›´æ–°æ–¹æ¡ˆæ€»è§ˆ

### å½“å‰çŠ¶æ€
- âœ… æ•°æ®åº“ä¸­æœ‰é™æ€æµ‹è¯•æ•°æ®ï¼ˆ2024å¹´1-6æœˆï¼‰
- âœ… å‰ç«¯å¯ä»¥æ­£å¸¸æ˜¾ç¤ºæ•°æ®
- âš ï¸ æ•°æ®ä¸ä¼šè‡ªåŠ¨æ›´æ–°

### æ›´æ–°æ–¹æ¡ˆ

## æ–¹æ¡ˆä¸€ï¼šå®šæ—¶ä»»åŠ¡è‡ªåŠ¨è®¡ç®—ï¼ˆæ¨èï¼‰â­

### 1. å·¥ä½œåŸç†

```
æ¯å¤©å‡Œæ™¨2ç‚¹ â†’ è®¡ç®—å‰ä¸€å¤©çš„æ•°æ® â†’ ä¿å­˜åˆ°æ•°æ®åº“
æ¯æœˆ1å·å‡Œæ™¨3ç‚¹ â†’ è®¡ç®—ä¸Šä¸ªæœˆçš„æ•°æ® â†’ ä¿å­˜åˆ°æ•°æ®åº“
```

### 2. æ ¸å¿ƒç®—æ³•

#### æ•™å­¦æ•ˆç‡è®¡ç®—å…¬å¼

```
æ•™å­¦æ•ˆç‡åˆ†æ•° = (
    å¹³å‡æˆç»© Ã— 35% +
    å­¦ç”Ÿå‚ä¸åº¦ Ã— 25% +
    è¯¾ç¨‹å®Œæˆç‡ Ã— 20% +
    è€ƒè¯•åŠæ ¼ç‡ Ã— 20%
)

ç„¶åæ˜ å°„åˆ° 40-95 åˆ†çš„åˆç†åŒºé—´
```

#### å„æŒ‡æ ‡è®¡ç®—æ–¹æ³•

| æŒ‡æ ‡ | è®¡ç®—æ–¹æ³• | æ•°æ®æ¥æº |
|------|---------|---------|
| **å¹³å‡æˆç»©** | AVG(score) | student_exam è¡¨ |
| **å­¦ç”Ÿå‚ä¸åº¦** | (æ´»è·ƒå­¦ç”Ÿæ•° / æ€»å­¦ç”Ÿæ•°) Ã— 100 | student_progress è¡¨ |
| **è¯¾ç¨‹å®Œæˆç‡** | (å·²å®Œæˆè¯¾ç¨‹æ•° / æ€»è¯¾ç¨‹æ•°) Ã— 100 | student_progress è¡¨ |
| **åŠæ ¼ç‡** | (åŠæ ¼äººæ•° / æ€»äººæ•°) Ã— 100 | student_exam è¡¨ |
| **ä¼˜ç§€ç‡** | (90åˆ†ä»¥ä¸Šäººæ•° / æ€»äººæ•°) Ã— 100 | student_exam è¡¨ |
| **æ•™å­¦æ—¶é•¿** | SUM(study_time) / 60 | student_progress è¡¨ |

### 3. å®ç°æ­¥éª¤

#### æ­¥éª¤1ï¼šå¯ç”¨å®šæ—¶ä»»åŠ¡

åœ¨ Spring Boot ä¸»ç±»ä¸Šæ·»åŠ æ³¨è§£ï¼š

```java
@SpringBootApplication
@EnableScheduling  // æ·»åŠ è¿™ä¸ªæ³¨è§£
public class WebExperimentApplication {
    public static void main(String[] args) {
        SpringApplication.run(WebExperimentApplication.class, args);
    }
}
```

#### æ­¥éª¤2ï¼šå®Œå–„è¾…åŠ©æ–¹æ³•

éœ€è¦åœ¨å„ä¸ª Mapper ä¸­æ·»åŠ æŸ¥è¯¢æ–¹æ³•ï¼Œä¾‹å¦‚ï¼š

**StudentExamMapper.java**
```java
// æŸ¥è¯¢æŸå¤©çš„å¹³å‡æˆç»©
@Select("SELECT AVG(score) FROM student_exam se " +
        "JOIN exam e ON se.exam_id = e.id " +
        "JOIN course c ON e.course_id = c.id " +
        "WHERE c.teacher_id = #{teacherId} " +
        "AND DATE(se.submit_time) = #{date}")
Double selectAvgScoreByDate(@Param("teacherId") Long teacherId, 
                            @Param("date") LocalDate date);

// æŸ¥è¯¢æŸæœˆçš„å¹³å‡æˆç»©
@Select("SELECT AVG(score) FROM student_exam se " +
        "JOIN exam e ON se.exam_id = e.id " +
        "JOIN course c ON e.course_id = c.id " +
        "WHERE c.teacher_id = #{teacherId} " +
        "AND DATE(se.submit_time) BETWEEN #{startDate} AND #{endDate}")
Double selectAvgScoreByMonth(@Param("teacherId") Long teacherId,
                             @Param("startDate") LocalDate startDate,
                             @Param("endDate") LocalDate endDate);

// æŸ¥è¯¢åŠæ ¼ç‡
@Select("SELECT COUNT(CASE WHEN score >= 60 THEN 1 END) * 100.0 / COUNT(*) " +
        "FROM student_exam se " +
        "JOIN exam e ON se.exam_id = e.id " +
        "JOIN course c ON e.course_id = c.id " +
        "WHERE c.teacher_id = #{teacherId} " +
        "AND DATE(se.submit_time) BETWEEN #{startDate} AND #{endDate}")
Double selectPassRateByPeriod(@Param("teacherId") Long teacherId,
                              @Param("startDate") LocalDate startDate,
                              @Param("endDate") LocalDate endDate);
```

**StudentProgressMapper.java**
```java
// æŸ¥è¯¢æ´»è·ƒå­¦ç”Ÿæ•°
@Select("SELECT COUNT(DISTINCT student_id) FROM student_progress " +
        "WHERE course_id IN (SELECT id FROM course WHERE teacher_id = #{teacherId}) " +
        "AND DATE(last_study_time) = #{date}")
Integer selectActiveStudentCount(@Param("teacherId") Long teacherId,
                                 @Param("date") LocalDate date);

// æŸ¥è¯¢æ•™å­¦æ—¶é•¿
@Select("SELECT SUM(study_time) / 60.0 FROM student_progress " +
        "WHERE course_id IN (SELECT id FROM course WHERE teacher_id = #{teacherId}) " +
        "AND DATE(last_study_time) BETWEEN #{startDate} AND #{endDate}")
Double selectTeachingHours(@Param("teacherId") Long teacherId,
                          @Param("startDate") LocalDate startDate,
                          @Param("endDate") LocalDate endDate);
```

#### æ­¥éª¤3ï¼šæµ‹è¯•å®šæ—¶ä»»åŠ¡

å¯ä»¥æ‰‹åŠ¨è§¦å‘æµ‹è¯•ï¼š

```java
@RestController
@RequestMapping("/api/test")
public class TestController {
    
    @Autowired
    private EfficiencyCalculationTask calculationTask;
    
    // æ‰‹åŠ¨è§¦å‘æ—¥åº¦è®¡ç®—
    @GetMapping("/calculate-daily")
    public Result testDailyCalculation() {
        calculationTask.calculateDailyEfficiency();
        return Result.success("æ—¥åº¦è®¡ç®—å®Œæˆ");
    }
    
    // æ‰‹åŠ¨è§¦å‘æœˆåº¦è®¡ç®—
    @GetMapping("/calculate-monthly")
    public Result testMonthlyCalculation() {
        calculationTask.calculateMonthlyEfficiency();
        return Result.success("æœˆåº¦è®¡ç®—å®Œæˆ");
    }
}
```

## æ–¹æ¡ˆäºŒï¼šå®æ—¶è®¡ç®—ï¼ˆç®€å•ä½†æ€§èƒ½è¾ƒå·®ï¼‰

ä¸ä¿å­˜å†å²æ•°æ®ï¼Œæ¯æ¬¡è¯·æ±‚æ—¶å®æ—¶è®¡ç®—ï¼š

```java
@Override
public Map<String, Object> getEfficiencyTrend(Long teacherId, String type) {
    if ("month".equals(type)) {
        // å®æ—¶è®¡ç®—æœ€è¿‘6ä¸ªæœˆçš„æ•°æ®
        List<Map<String, Object>> monthlyData = new ArrayList<>();
        LocalDate now = LocalDate.now();
        
        for (int i = 5; i >= 0; i--) {
            LocalDate month = now.minusMonths(i);
            LocalDate start = month.withDayOfMonth(1);
            LocalDate end = month.withDayOfMonth(month.lengthOfMonth());
            
            // å®æ—¶è®¡ç®—è¯¥æœˆæ•°æ®
            Double efficiency = calculateEfficiencyForPeriod(teacherId, start, end);
            Integer courseCount = getCourseCountForPeriod(teacherId, start, end);
            Double engagement = calculateEngagementForPeriod(teacherId, start, end);
            
            Map<String, Object> data = new HashMap<>();
            data.put("month", month.getMonthValue() + "æœˆ");
            data.put("efficiency", efficiency);
            data.put("courseCount", courseCount);
            data.put("studentEngagement", engagement);
            
            monthlyData.add(data);
        }
        
        result.put("monthly", monthlyData);
    }
    
    return result;
}
```

**ä¼˜ç‚¹**ï¼š
- âœ… å®ç°ç®€å•
- âœ… æ•°æ®å§‹ç»ˆæ˜¯æœ€æ–°çš„

**ç¼ºç‚¹**ï¼š
- âŒ æ¯æ¬¡è¯·æ±‚éƒ½è¦è®¡ç®—ï¼Œæ€§èƒ½å·®
- âŒ æ•°æ®åº“æŸ¥è¯¢å‹åŠ›å¤§
- âŒ å“åº”æ—¶é—´é•¿

## æ–¹æ¡ˆä¸‰ï¼šæ··åˆæ–¹æ¡ˆï¼ˆæœ€ä½³å®è·µï¼‰

ç»“åˆå®šæ—¶ä»»åŠ¡å’Œå®æ—¶è®¡ç®—ï¼š

```java
@Override
public Map<String, Object> getEfficiencyTrend(Long teacherId, String type) {
    // 1. å…ˆä»æ•°æ®åº“æŸ¥è¯¢å†å²æ•°æ®
    List<TeacherEfficiencyTrend> trends = efficiencyTrendMapper.selectMonthlyTrend(...);
    
    // 2. å¦‚æœæ•°æ®ä¸å®Œæ•´ï¼Œå®æ—¶è®¡ç®—ç¼ºå¤±çš„éƒ¨åˆ†
    if (trends.size() < 6) {
        // æ‰¾å‡ºç¼ºå¤±çš„æœˆä»½
        List<LocalDate> missingMonths = findMissingMonths(trends);
        
        // å®æ—¶è®¡ç®—ç¼ºå¤±æœˆä»½çš„æ•°æ®
        for (LocalDate month : missingMonths) {
            TeacherEfficiencyTrend trend = calculateMonthlyEfficiencyForTeacher(teacherId, month);
            trends.add(trend);
            
            // å¼‚æ­¥ä¿å­˜åˆ°æ•°æ®åº“
            efficiencyTrendMapper.insertOrUpdate(trend);
        }
    }
    
    // 3. è¿”å›å®Œæ•´æ•°æ®
    return convertToResponse(trends);
}
```

## ğŸ“ˆ ç®—æ³•ä¼˜åŒ–å»ºè®®

### 1. æƒé‡å¯é…ç½®åŒ–

å°†æƒé‡é…ç½®åˆ°é…ç½®æ–‡ä»¶ä¸­ï¼š

```yaml
# application.yml
efficiency:
  weights:
    score: 0.35        # å¹³å‡æˆç»©æƒé‡
    engagement: 0.25   # å­¦ç”Ÿå‚ä¸åº¦æƒé‡
    completion: 0.20   # å®Œæˆç‡æƒé‡
    pass-rate: 0.20    # åŠæ ¼ç‡æƒé‡
```

### 2. ç¼“å­˜ä¼˜åŒ–

ä½¿ç”¨ Redis ç¼“å­˜è®¡ç®—ç»“æœï¼š

```java
@Cacheable(value = "efficiency", key = "#teacherId + '_' + #type")
public Map<String, Object> getEfficiencyTrend(Long teacherId, String type) {
    // ...
}
```

### 3. å¼‚æ­¥è®¡ç®—

ä½¿ç”¨å¼‚æ­¥ä»»åŠ¡é¿å…é˜»å¡ï¼š

```java
@Async
public CompletableFuture<TeacherEfficiencyTrend> calculateEfficiencyAsync(Long teacherId, LocalDate date) {
    TeacherEfficiencyTrend trend = calculateDailyEfficiencyForTeacher(teacherId, date);
    return CompletableFuture.completedFuture(trend);
}
```

### 4. æ•°æ®æ¸…ç†

å®šæœŸæ¸…ç†è¿‡æœŸæ•°æ®ï¼š

```java
@Scheduled(cron = "0 0 4 1 * ?") // æ¯æœˆ1å·å‡Œæ™¨4ç‚¹
public void cleanOldData() {
    // åˆ é™¤1å¹´å‰çš„æ—¥åº¦æ•°æ®
    LocalDate oneYearAgo = LocalDate.now().minusYears(1);
    efficiencyTrendMapper.deleteBeforeDate(oneYearAgo);
}
```

## ğŸ¯ æ¨èå®æ–½æ–¹æ¡ˆ

### çŸ­æœŸï¼ˆ1-2å¤©ï¼‰
1. âœ… ä½¿ç”¨å½“å‰çš„é™æ€æµ‹è¯•æ•°æ®
2. âœ… å‰ç«¯æ­£å¸¸æ˜¾ç¤º
3. âš ï¸ æ•°æ®ä¸è‡ªåŠ¨æ›´æ–°ï¼ˆæ¼”ç¤ºå¤Ÿç”¨ï¼‰

### ä¸­æœŸï¼ˆ1å‘¨ï¼‰
1. å®ç°å®šæ—¶ä»»åŠ¡æ¡†æ¶
2. å®Œå–„æ•°æ®æŸ¥è¯¢æ–¹æ³•
3. å®ç°æ ¸å¿ƒè®¡ç®—ç®—æ³•
4. æ·»åŠ æ‰‹åŠ¨è§¦å‘æ¥å£ç”¨äºæµ‹è¯•

### é•¿æœŸï¼ˆ1ä¸ªæœˆï¼‰
1. ä¼˜åŒ–ç®—æ³•æƒé‡
2. æ·»åŠ ç¼“å­˜æœºåˆ¶
3. å®ç°å¼‚æ­¥è®¡ç®—
4. æ·»åŠ æ•°æ®æ¸…ç†ä»»åŠ¡
5. å®Œå–„ç›‘æ§å’Œæ—¥å¿—

## ğŸ“ å¿«é€Ÿå¼€å§‹

### 1. å¯ç”¨å®šæ—¶ä»»åŠ¡

åœ¨ä¸»ç±»æ·»åŠ  `@EnableScheduling`ï¼š

```java
@SpringBootApplication
@EnableScheduling
public class WebExperimentApplication {
    // ...
}
```

### 2. æµ‹è¯•æ‰‹åŠ¨è®¡ç®—

è®¿é—®ï¼š
```
http://localhost:8080/api/test/calculate-daily
http://localhost:8080/api/test/calculate-monthly
```

### 3. æŸ¥çœ‹è®¡ç®—ç»“æœ

```sql
SELECT * FROM teacher_efficiency_trend 
WHERE teacher_id = 2 
ORDER BY stat_date DESC 
LIMIT 10;
```

## â“ å¸¸è§é—®é¢˜

### Q1: å®šæ—¶ä»»åŠ¡ä»€ä¹ˆæ—¶å€™æ‰§è¡Œï¼Ÿ
- æ—¥åº¦ï¼šæ¯å¤©å‡Œæ™¨2ç‚¹
- æœˆåº¦ï¼šæ¯æœˆ1å·å‡Œæ™¨3ç‚¹

### Q2: å¦‚ä½•ä¿®æ”¹æ‰§è¡Œæ—¶é—´ï¼Ÿ
ä¿®æ”¹ `@Scheduled` æ³¨è§£çš„ cron è¡¨è¾¾å¼ï¼š
```java
@Scheduled(cron = "0 0 2 * * ?")  // ç§’ åˆ† æ—¶ æ—¥ æœˆ å‘¨
```

### Q3: å¦‚ä½•è°ƒæ•´ç®—æ³•æƒé‡ï¼Ÿ
ä¿®æ”¹ `calculateEfficiencyScore` æ–¹æ³•ä¸­çš„æƒé‡å€¼ã€‚

### Q4: æ•°æ®ä¿ç•™å¤šä¹…ï¼Ÿ
å»ºè®®ï¼š
- æ—¥åº¦æ•°æ®ï¼šä¿ç•™1å¹´
- æœˆåº¦æ•°æ®ï¼šæ°¸ä¹…ä¿ç•™

## ğŸ‰ æ€»ç»“

ç›®å‰æ‚¨çš„ç³»ç»Ÿï¼š
- âœ… æ•°æ®åº“æœ‰æµ‹è¯•æ•°æ®
- âœ… å‰ç«¯å¯ä»¥æ­£å¸¸æ˜¾ç¤º
- âœ… å·²æä¾›å®Œæ•´çš„å®šæ—¶ä»»åŠ¡æ¡†æ¶
- âš ï¸ éœ€è¦å®Œå–„å…·ä½“çš„æŸ¥è¯¢æ–¹æ³•

å¦‚æœåªæ˜¯æ¼”ç¤ºç”¨é€”ï¼Œå½“å‰çš„é™æ€æ•°æ®å·²ç»è¶³å¤Ÿã€‚å¦‚æœéœ€è¦ç”Ÿäº§ç¯å¢ƒä½¿ç”¨ï¼Œå»ºè®®å®ç°å®šæ—¶ä»»åŠ¡è‡ªåŠ¨æ›´æ–°ã€‚


