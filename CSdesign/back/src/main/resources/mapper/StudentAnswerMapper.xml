<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.experiment.mapper.StudentAnswerMapper">
    
    <resultMap id="StudentAnswerResultMap" type="com.experiment.pojo.StudentAnswer">
        <id column="id" property="id"/>
        <result column="student_exam_id" property="studentExamId"/>
        <result column="question_id" property="questionId"/>
        <result column="answer" property="answer"/>
        <result column="is_correct" property="isCorrect"/>
        <result column="score" property="score"/>
        <result column="teacher_comment" property="teacherComment"/>
        <result column="create_time" property="createTime"/>
        <result column="update_time" property="updateTime"/>
    </resultMap>
    
    <insert id="insert" parameterType="com.experiment.pojo.StudentAnswer" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO student_answer (student_exam_id, question_id, answer, is_correct, score, teacher_comment, create_time, update_time)
        VALUES (#{studentExamId}, #{questionId}, #{answer}, #{isCorrect}, #{score}, #{teacherComment}, #{createTime}, #{updateTime})
    </insert>
    
    <insert id="batchInsert">
        INSERT INTO student_answer (student_exam_id, question_id, answer, is_correct, score, teacher_comment, create_time, update_time)
        VALUES
        <foreach collection="answers" item="item" separator=",">
            (#{item.studentExamId}, #{item.questionId}, #{item.answer}, #{item.isCorrect}, #{item.score}, #{item.teacherComment}, #{item.createTime}, #{item.updateTime})
        </foreach>
    </insert>
    
    <select id="selectById" resultMap="StudentAnswerResultMap">
        SELECT * FROM student_answer WHERE id = #{id}
    </select>
    
    <select id="selectByStudentExamId" resultMap="StudentAnswerResultMap">
        SELECT * FROM student_answer WHERE student_exam_id = #{studentExamId}
    </select>
    
    <select id="selectByStudentExamAndQuestion" resultMap="StudentAnswerResultMap">
        SELECT * FROM student_answer 
        WHERE student_exam_id = #{studentExamId} AND question_id = #{questionId}
    </select>
    
    <update id="update" parameterType="com.experiment.pojo.StudentAnswer">
        UPDATE student_answer 
        SET student_exam_id = #{studentExamId}, question_id = #{questionId}, answer = #{answer},
            is_correct = #{isCorrect}, score = #{score}, teacher_comment = #{teacherComment},
            update_time = #{updateTime}
        WHERE id = #{id}
    </update>
    
    <delete id="deleteById">
        DELETE FROM student_answer WHERE id = #{id}
    </delete>
    
    <delete id="deleteByStudentExamId">
        DELETE FROM student_answer WHERE student_exam_id = #{studentExamId}
    </delete>
    
    <!-- 查询学生的所有错题 -->
    <select id="selectErrorQuestionsByStudentId" resultType="java.util.Map">
        SELECT 
            sa.question_id,
            q.content as question_content,
            q.type as question_type,
            q.knowledge_point,
            q.difficulty,
            q.answer as correct_answer,
            sa.answer as student_answer,
            MAX(sa.create_time) as last_error_time,
            COUNT(*) as error_count,
            (SELECT COUNT(*) FROM student_answer sa2 
             INNER JOIN student_exam se2 ON sa2.student_exam_id = se2.id
             WHERE se2.student_id = #{studentId} AND sa2.question_id = sa.question_id) as total_attempts
        FROM student_answer sa
        INNER JOIN student_exam se ON sa.student_exam_id = se.id
        INNER JOIN question q ON sa.question_id = q.id
        WHERE se.student_id = #{studentId} 
        AND sa.is_correct = 0
        GROUP BY sa.question_id, q.content, q.type, q.knowledge_point, q.difficulty, q.answer, sa.answer
        ORDER BY last_error_time DESC
    </select>
    
    <!-- 查询学生某道题的错误记录 -->
    <select id="selectErrorRecordsByStudentAndQuestion" resultType="java.util.Map">
        SELECT 
            sa.id,
            sa.answer as student_answer,
            sa.create_time,
            q.answer as correct_answer,
            q.content as question_content,
            q.type as question_type,
            q.knowledge_point,
            q.difficulty,
            e.title as exam_title
        FROM student_answer sa
        INNER JOIN student_exam se ON sa.student_exam_id = se.id
        INNER JOIN question q ON sa.question_id = q.id
        INNER JOIN exam e ON se.exam_id = e.id
        WHERE se.student_id = #{studentId} 
        AND sa.question_id = #{questionId}
        AND sa.is_correct = 0
        ORDER BY sa.create_time DESC
    </select>
    
    <!-- 统计学生某道题的错误次数 -->
    <select id="countErrorsByStudentAndQuestion" resultType="java.lang.Integer">
        SELECT COUNT(*)
        FROM student_answer sa
        INNER JOIN student_exam se ON sa.student_exam_id = se.id
        WHERE se.student_id = #{studentId} 
        AND sa.question_id = #{questionId}
        AND sa.is_correct = 0
    </select>
    
    <!-- 统计学生某道题的总答题次数 -->
    <select id="countTotalByStudentAndQuestion" resultType="java.lang.Integer">
        SELECT COUNT(*)
        FROM student_answer sa
        INNER JOIN student_exam se ON sa.student_exam_id = se.id
        WHERE se.student_id = #{studentId} 
        AND sa.question_id = #{questionId}
    </select>

</mapper>
