<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.experiment.mapper.ClassSummaryMapper">

    <!-- 结果映射 -->
    <resultMap id="ClassSummaryMap" type="com.experiment.pojo.ClassSummary">
        <id property="id" column="id"/>
        <result property="courseId" column="course_id"/>
        <result property="teacherId" column="teacher_id"/>
        <result property="title" column="title"/>
        <result property="description" column="description"/>
        <result property="audioFilePath" column="audio_file_path"/>
        <result property="audioDuration" column="audio_duration"/>
        <result property="coursewareFilePath" column="courseware_file_path"/>
        <result property="transcriptText" column="transcript_text"/>
        <result property="summaryContent" column="summary_content"/>
        <result property="finalContent" column="final_content"/>
        <result property="status" column="status"/>
        <result property="publishTime" column="publish_time"/>
        <result property="createTime" column="create_time"/>
        <result property="updateTime" column="update_time"/>
        <result property="courseName" column="course_name"/>
        <result property="teacherName" column="teacher_name"/>
        <result property="viewCount" column="view_count"/>
        <result property="keywords" column="keywords"/>
    </resultMap>

    <!-- 插入课堂总结 -->
    <insert id="insert" parameterType="com.experiment.pojo.ClassSummary" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO class_summary (
            course_id, teacher_id, title, description, audio_file_path, audio_duration,
            courseware_file_path, transcript_text, summary_content, final_content,
            status, keywords, create_time, update_time
        ) VALUES (
            #{courseId}, #{teacherId}, #{title}, #{description}, #{audioFilePath}, #{audioDuration},
            #{coursewareFilePath}, #{transcriptText}, #{summaryContent}, #{finalContent},
            #{status}, #{keywords}, #{createTime}, #{updateTime}
        )
    </insert>

    <!-- 根据ID查询 -->
    <select id="selectById" resultMap="ClassSummaryMap">
        SELECT cs.*, c.title as course_name, u.real_name as teacher_name
        FROM class_summary cs
        LEFT JOIN course c ON cs.course_id = c.id
        LEFT JOIN user u ON cs.teacher_id = u.id
        WHERE cs.id = #{id}
    </select>

    <!-- 根据教师ID查询 -->
    <select id="selectByTeacherId" resultMap="ClassSummaryMap">
        SELECT cs.*, c.title as course_name, u.real_name as teacher_name
        FROM class_summary cs
        LEFT JOIN course c ON cs.course_id = c.id
        LEFT JOIN user u ON cs.teacher_id = u.id
        WHERE cs.teacher_id = #{teacherId}
        ORDER BY cs.create_time DESC
    </select>

    <!-- 根据课程ID查询已发布的总结 -->
    <select id="selectPublishedByCourseId" resultMap="ClassSummaryMap">
        SELECT cs.*, c.title as course_name, u.real_name as teacher_name
        FROM class_summary cs
        LEFT JOIN course c ON cs.course_id = c.id
        LEFT JOIN user u ON cs.teacher_id = u.id
        WHERE cs.course_id = #{courseId} AND cs.status = 'PUBLISHED'
        ORDER BY cs.publish_time DESC
    </select>

    <!-- 查询所有已发布的总结 -->
    <select id="selectAllPublished" resultMap="ClassSummaryMap">
        SELECT cs.*, c.title as course_name, u.real_name as teacher_name
        FROM class_summary cs
        LEFT JOIN course c ON cs.course_id = c.id
        LEFT JOIN user u ON cs.teacher_id = u.id
        WHERE cs.status = 'PUBLISHED'
        ORDER BY cs.publish_time DESC
    </select>

    <!-- 更新课堂总结 -->
    <update id="update" parameterType="com.experiment.pojo.ClassSummary">
        UPDATE class_summary
        <set>
            <if test="title != null">title = #{title},</if>
            <if test="description != null">description = #{description},</if>
            <if test="audioFilePath != null">audio_file_path = #{audioFilePath},</if>
            <if test="audioDuration != null">audio_duration = #{audioDuration},</if>
            <if test="coursewareFilePath != null">courseware_file_path = #{coursewareFilePath},</if>
            <if test="transcriptText != null">transcript_text = #{transcriptText},</if>
            <if test="summaryContent != null">summary_content = #{summaryContent},</if>
            <if test="finalContent != null">final_content = #{finalContent},</if>
            <if test="status != null">status = #{status},</if>
            <if test="keywords != null">keywords = #{keywords},</if>
            <if test="publishTime != null">publish_time = #{publishTime},</if>
            update_time = NOW()
        </set>
        WHERE id = #{id}
    </update>

    <!-- 更新转录文本 -->
    <update id="updateTranscriptText">
        UPDATE class_summary SET
            transcript_text = #{transcriptText},
            update_time = NOW()
        WHERE id = #{id}
    </update>

    <!-- 更新AI生成的总结内容 -->
    <update id="updateSummaryContent">
        UPDATE class_summary SET
            summary_content = #{summaryContent},
            update_time = NOW()
        WHERE id = #{id}
    </update>

    <!-- 更新最终文档内容 -->
    <update id="updateFinalContent">
        UPDATE class_summary SET
            final_content = #{finalContent},
            update_time = NOW()
        WHERE id = #{id}
    </update>

    <!-- 更新状态 -->
    <update id="updateStatus">
        UPDATE class_summary SET
            status = #{status},
            <if test="publishTime != null">
                publish_time = #{publishTime},
            </if>
            update_time = NOW()
        WHERE id = #{id}
    </update>

    <!-- 增加浏览次数 -->
    <update id="incrementViewCount">
        UPDATE class_summary SET
            view_count = COALESCE(view_count, 0) + 1,
            update_time = NOW()
        WHERE id = #{id}
    </update>

    <!-- 删除课堂总结 -->
    <delete id="deleteById">
        DELETE FROM class_summary WHERE id = #{id}
    </delete>

    <!-- 根据关键词搜索 -->
    <select id="searchPublished" resultMap="ClassSummaryMap">
        SELECT cs.*, c.title as course_name, u.real_name as teacher_name
        FROM class_summary cs
        LEFT JOIN course c ON cs.course_id = c.id
        LEFT JOIN user u ON cs.teacher_id = u.id
        WHERE cs.status = 'PUBLISHED'
        AND (
            cs.title LIKE CONCAT('%', #{keyword}, '%')
            OR cs.description LIKE CONCAT('%', #{keyword}, '%')
            OR cs.keywords LIKE CONCAT('%', #{keyword}, '%')
            OR c.title LIKE CONCAT('%', #{keyword}, '%')
        )
        ORDER BY cs.publish_time DESC
    </select>

</mapper> 